<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
<!ENTITY name      "custom.smb.shares">
<!ENTITY author    "cslemieux">
<!ENTITY version   "2026.01.20">
<!ENTITY launch    "SMBShares">
<!ENTITY github    "cslemieux/unraid-custom-smb-shares">
<!ENTITY pluginURL "https://raw.githubusercontent.com/&github;/main/&name;.plg">
<!ENTITY md5       "de5647b712c36b8d7bd280bf82186a89">
<!ENTITY plugdir   "/usr/local/emhttp/plugins/&name;">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
]>

<PLUGIN name="&name;" 
        author="&author;" 
        version="&version;" 
        launch="&launch;" 
        pluginURL="&pluginURL;"
        min="6.12.0"
        support="https://forums.unraid.net/topic/195826-plugin-custom-smb-shares/"
        icon="share-alt">

<CHANGES>
##&name;

###2026.01.19
- Fix: User access permissions now save correctly
- Test: Add comprehensive test pyramid for SMB security settings (57 new tests)
- Test: Unit tests for security config builders
- Test: Integration tests for save/load cycle
- Test: E2E tests for UI interactions
- Tests: 344 tests, 832 assertions - all passing

###2025.12.14f
- CI: Add CI status check to release script
- Support: Add forum support thread

###2025.12.14e
- CI: Install dev dependencies in build job for linting

###2025.12.14d
- CI: Limit test coverage to unit/integration (skip E2E in CI)
- CI: Add MIT license to composer.json

###2025.12.14c
- Security: Prevent Samba config injection via newlines in share fields
- Security: Fix TOCTOU symlink race condition in path validation
- Refactor: Extract helper functions from generateSambaConfig()
- Quality: Add concurrent modification tests (6 new tests)
- Quality: Add JSDoc documentation to JavaScript
- Quality: Extract magic strings to ConfigRegistry constants
- Tests: 287 tests, 645 assertions - all passing

###2025.12.14a
- Initial release v1.0.0
- Full share CRUD operations (Create, Read, Update, Delete)
- Enable/disable toggle with loading states
- Clone share functionality
- Import/export configuration as JSON
- Backup management with configurable retention
- macOS/Time Machine support with Fruit VFS
- Advanced permission settings (masks, force user/group)
- Host allow/deny lists
- Security modes: Public, Secure, Private
- User/group browser with search
- Path browser with visual directory picker
- Real-time validation with helpful error messages
- Toast notifications for all actions
- Feature icons for quick visual reference
- Automatic Samba configuration and reload
- Comprehensive test suite (274 tests)
</CHANGES>

<!-- Pre-install: cleanup old versions -->
<FILE Run="/bin/bash">
<INLINE>
echo "Cleaning up old versions..."
rm -f $(ls &plgPATH;/&name;*.txz 2>/dev/null | grep -v '&version;')
rm -f $(ls &plgPATH;/&name;*.md5 2>/dev/null | grep -v '&version;')
</INLINE>
</FILE>

<!-- Remove old package if exists, then install new -->
<FILE Name="&plgPATH;/&name;-&version;-x86_64-1.txz">
<URL>https://github.com/&github;/releases/download/v&version;/&name;-&version;-x86_64-1.txz</URL>
<MD5>&md5;</MD5>
</FILE>

<FILE Run="/bin/bash">
<INLINE>
# Remove any existing package versions
removepkg &name; 2>/dev/null || true
# Install the new package
installpkg &plgPATH;/&name;-&version;-x86_64-1.txz
</INLINE>
</FILE>

<!-- Post-install: setup config -->
<FILE Run="/bin/bash">
<INLINE>
# Create config directory
mkdir -p &plgPATH;
mkdir -p &plgPATH;/backups

# Initialize shares.json if it doesn't exist
if [ ! -f "&plgPATH;/shares.json" ]; then
  echo "[]" > &plgPATH;/shares.json
fi

# Initialize settings.cfg if it doesn't exist
if [ ! -f "&plgPATH;/settings.cfg" ]; then
  echo 'SERVICE="enabled"' > &plgPATH;/settings.cfg
  echo 'BACKUP_COUNT="10"' >> &plgPATH;/settings.cfg
fi

# Set permissions
chmod 644 &plgPATH;/shares.json
chmod 644 &plgPATH;/settings.cfg
chmod 755 &plugdir;/scripts/*.sh 2>/dev/null || true

echo ""
echo "----------------------------------------------------"
echo " &name; has been installed."
echo " Version: &version;"
echo " Access via: Tasks > SMB Shares"
echo "----------------------------------------------------"
echo ""
</INLINE>
</FILE>

<!-- Remove script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
echo "Removing &name;..."

# Remove plugin package
removepkg &name;-&version;-x86_64-1

# Remove runtime files
rm -rf &plugdir;

# Note: Configuration files in &plgPATH; are preserved
echo ""
echo "----------------------------------------------------"
echo " &name; has been removed."
echo " Configuration preserved in &plgPATH;"
echo " To remove config: rm -rf &plgPATH;"
echo "----------------------------------------------------"
echo ""
</INLINE>
</FILE>

</PLUGIN>
